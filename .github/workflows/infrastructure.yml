name: Infrastructure - Deploy CloudFormation Stack

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'create'
        type: choice
        options:
          - create
          - update
          - delete

env:
  AWS_REGION: us-east-1
  STACK_NAME: cinch-infrastructure

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Create ECR Repositories (if not exist)
        if: github.event.inputs.action == 'create'
        run: |
          aws ecr describe-repositories --repository-names cinch/catalog --region ${{ env.AWS_REGION }} || \
            aws ecr create-repository --repository-name cinch/catalog --region ${{ env.AWS_REGION }}

          aws ecr describe-repositories --repository-names cinch/checkout --region ${{ env.AWS_REGION }} || \
            aws ecr create-repository --repository-name cinch/checkout --region ${{ env.AWS_REGION }}

          aws ecr describe-repositories --repository-names cinch/email --region ${{ env.AWS_REGION }} || \
            aws ecr create-repository --repository-name cinch/email --region ${{ env.AWS_REGION }}

          aws ecr describe-repositories --repository-names cinch/frontend --region ${{ env.AWS_REGION }} || \
            aws ecr create-repository --repository-name cinch/frontend --region ${{ env.AWS_REGION }}

      - name: Update Parameters File
        if: github.event.inputs.action == 'create' || github.event.inputs.action == 'update'
        run: |
          # Update ECR image URIs in parameters file
          jq --arg account "${{ steps.account.outputs.account_id }}" \
             --arg region "${{ env.AWS_REGION }}" \
             '
             map(
               if .ParameterKey == "CatalogImageUri" then
                 .ParameterValue = ($account + ".dkr.ecr." + $region + ".amazonaws.com/cinch/catalog:latest")
               elif .ParameterKey == "CheckoutImageUri" then
                 .ParameterValue = ($account + ".dkr.ecr." + $region + ".amazonaws.com/cinch/checkout:latest")
               elif .ParameterKey == "EmailImageUri" then
                 .ParameterValue = ($account + ".dkr.ecr." + $region + ".amazonaws.com/cinch/email:latest")
               elif .ParameterKey == "FrontendImageUri" then
                 .ParameterValue = ($account + ".dkr.ecr." + $region + ".amazonaws.com/cinch/frontend:latest")
               elif .ParameterKey == "CatalogAppKey" then
                 .ParameterValue = "${{ secrets.CATALOG_APP_KEY }}"
               elif .ParameterKey == "CheckoutAppKey" then
                 .ParameterValue = "${{ secrets.CHECKOUT_APP_KEY }}"
               elif .ParameterKey == "EmailAppKey" then
                 .ParameterValue = "${{ secrets.EMAIL_APP_KEY }}"
               elif .ParameterKey == "DBPassword" then
                 .ParameterValue = "${{ secrets.DB_PASSWORD }}"
               elif .ParameterKey == "RedisPassword" then
                 .ParameterValue = "${{ secrets.REDIS_PASSWORD }}"
               elif .ParameterKey == "SMTPHost" then
                 .ParameterValue = "${{ secrets.SMTP_HOST }}"
               elif .ParameterKey == "SMTPPort" then
                 .ParameterValue = "${{ secrets.SMTP_PORT }}"
               elif .ParameterKey == "SMTPUsername" then
                 .ParameterValue = "${{ secrets.SMTP_USERNAME }}"
               elif .ParameterKey == "SMTPPassword" then
                 .ParameterValue = "${{ secrets.SMTP_PASSWORD }}"
               else
                 .
               end
             )
             ' infrastructure/parameters/cloudformation-parameters.json > cloudformation-parameters-updated.json

      - name: Validate CloudFormation Template
        if: github.event.inputs.action == 'create' || github.event.inputs.action == 'update'
        run: |
          aws cloudformation validate-template \
            --template-body file://infrastructure/scripts/cloudformation.yml \
            --region ${{ env.AWS_REGION }}

      - name: Create CloudFormation Stack
        if: github.event.inputs.action == 'create'
        run: |
          aws cloudformation create-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://infrastructure/scripts/cloudformation.yml \
            --parameters file://cloudformation-parameters-updated.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }}

          echo "Waiting for stack creation to complete..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Update CloudFormation Stack
        if: github.event.inputs.action == 'update'
        run: |
          aws cloudformation update-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://infrastructure/scripts/cloudformation.yml \
            --parameters file://cloudformation-parameters-updated.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} || echo "No updates to perform"

          echo "Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} || true

      - name: Delete CloudFormation Stack
        if: github.event.inputs.action == 'delete'
        run: |
          aws cloudformation delete-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }}

          echo "Waiting for stack deletion to complete..."
          aws cloudformation wait stack-delete-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Get Stack Outputs
        if: github.event.inputs.action == 'create' || github.event.inputs.action == 'update'
        run: |
          echo "=== CloudFormation Stack Outputs ==="
          aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output table

      - name: Get Application URL
        if: github.event.inputs.action == 'create' || github.event.inputs.action == 'update'
        run: |
          ALB_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerURL`].OutputValue' \
            --output text)

          echo "=== Deployment Complete ==="
          echo "Application URL: $ALB_URL"
          echo ""
          echo "Next steps:"
          echo "1. Build and push Docker images"
          echo "2. Run database migrations"
          echo "3. Access your application at: $ALB_URL"
